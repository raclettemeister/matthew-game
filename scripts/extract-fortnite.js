#!/usr/bin/env node
/**
 * Extracts the Fortnite minigame block from index.html and writes fortnite-minigame.js.
 * Rule: index.html is the single source of truth. Never edit minigame.html or fortnite-minigame.js by hand.
 * Run: node scripts/extract-fortnite.js
 */

const fs = require('fs');
const path = require('path');

const root = path.join(__dirname, '..');
const indexPath = path.join(root, 'index.html');
const outPath = path.join(root, 'fortnite-minigame.js');

const html = fs.readFileSync(indexPath, 'utf8');

// Find the Fortnite block: from "//  FORTNITE MINI-GAME" (in index) through "function stopFortnite() { ... }\n\nfunction triggerMom"
const startMarker = '// ══════════════════════════════════════════════\n//  FORTNITE MINI-GAME';
const startIdx = html.indexOf(startMarker);
if (startIdx === -1) {
  console.error('Could not find Fortnite block start in index.html');
  process.exit(1);
}

// End: after "function stopFortnite() { ... }", before "</script>" (do not include script tags in output)
const endMarker = '\n\n</script>\n<script>\nfunction triggerMom()';
const endIdx = html.indexOf(endMarker, startIdx);
if (endIdx === -1) {
  console.error('Could not find end of Fortnite block (</script> before triggerMom) in index.html');
  process.exit(1);
}
let block = html.slice(startIdx, endIdx);

// In index we have "const FN_W = W, FN_H = H;" — replace with standalone viewport logic
block = block.replace(
  /const FN_W = W, FN_H = H;\n/,
  `var __fnVp = window.__FN_VIEWPORT__ || { w: 960, h: 540 };\nvar FN_W = __fnVp.w, FN_H = __fnVp.h;\n`
);

// In index we have "let fn = null" — for standalone we need "var fn" so it's global
block = block.replace(/\blet fn = null\b/, 'var fn = null');

// Build output: header comment + block + exports
const header = `// FORTNITE MINI-GAME — generated from index.html. Do not edit this file.
// Run: node scripts/extract-fortnite.js
// ══════════════════════════════════════════════
`;

const exportsBlock = `
// Expose for minigame.html
window.FN_BTN_RETOUR = FN_BTN_RETOUR;
window.initFortnite = initFortnite;
window.updateFortnite = updateFortnite;
window.drawFortnite = drawFortnite;
window.stopFortnite = stopFortnite;
window.fnRef = function() { return fn; };
`;

const out = header + block + exportsBlock;
fs.writeFileSync(outPath, out, 'utf8');
console.log('Written fortnite-minigame.js from index.html');
console.log('Minigame will reflect index changes. Do not edit minigame.html or fortnite-minigame.js by hand.');
process.exit(0);
